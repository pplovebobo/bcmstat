# bcmstat - 樹莓派系統監控工具

專為樹莓派設計的進階命令列監控工具，具備全面的硬體支援：

## 支援的硬體
* 樹莓派 1、2、3、4、5 及 Pi5+
* Pi Zero、Pi Zero W、Pi Zero 2W
* 計算模組 (CM1、CM3、CM3+、CM4、CM4S、CM5)
* Pi400
* 最高支援 32GB RAM 記憶體配置

## 監控功能
* CPU 頻率監控 (ARM、Core、H264、V3D、ISP)
* 溫度監控 (核心和 PMIC 溫度，含峰值追蹤)
* IRQ/s 和系統中斷統計
* 網路 Rx/Tx 統計
* 完整的系統使用率 (user、nice、system、idle、iowait、irq)
* 多核心 CPU 負載監控
* GPU 記憶體使用情況 (reloc 和 malloc 池)
* RAM 使用情況 (可選擇包含 swap 監控)
* 記憶體洩漏檢測 (`D`/`A` 選項 - 即時和累積差值)
* 進階硬體監控 (欠壓、頻率限制、熱節流)
* 完全可自訂的欄位顯示

## 強化的權限處理
* 自動權限檢測和有用的錯誤訊息
* 需要提升權限時提供清晰的 sudo 提示
* 檢查 video 群組成員資格以達最佳 GPU 存取
* 當某些功能需要更高權限時優雅降級

已在現代樹莓派 OS、LibreELEC 和 OSMC 發行版上測試。

顯示值可以彩色化 (白色、綠色、黃色和紅色) 來突出顯示過度使用或資源耗盡。使用 `m` 選項停用。

使用 `-h` 查看所有可用選項。

**重要：** 為了在較新的樹莓派型號上完整運作，請以提升權限執行：
```bash
sudo python bcmstat.sh
```

在 ~/.bcmstat.conf 中指定預設配置，例如：
```
xgd10
```

## 安裝方式

### 快速安裝 (建議)
一行安裝腳本：
```bash
curl -sSL https://raw.githubusercontent.com/pplovebobo/bcmstat/master/install.sh | bash
```

### 手動安裝
直接從 GitHub 倉庫安裝最新版本：
```bash
# 下載腳本
curl -Ls https://raw.githubusercontent.com/pplovebobo/bcmstat/master/bcmstat.sh -o ~/bcmstat.sh
chmod +x ~/bcmstat.sh

# 以完整權限執行以獲得最佳效果
sudo python3 ~/bcmstat.sh
```

### Git 安裝
適合想要貢獻的開發者：
```bash
git clone https://github.com/pplovebobo/bcmstat.git
cd bcmstat
chmod +x bcmstat.sh
sudo python3 bcmstat.sh
```

## 使用範例

### 基本用法
```bash
# 基本監控
./bcmstat.sh

# 每 5 秒更新一次
./bcmstat.sh d5

# 彩色輸出，GPU 記憶體監控，每 10 秒更新
./bcmstat.sh cgd10
```

### 常用參數組合解釋

#### `./bcmstat.sh xgpd10` 參數詳解
這是一個常用的監控配置，各參數意義如下：

- **`x`**: 啟用詳細的 CPU 負載和記憶體使用統計
  - 顯示 %user (使用者程序)、%nice (低優先權程序)、%sys (系統程序)
  - 顯示 %idle (閒置)、%iowt (I/O 等待)、%irq (中斷處理)
  - 包含記憶體使用統計

- **`g`**: 啟用 GPU 記憶體統計 (reloc 記憶體池)
  - 顯示 GPU 記憶體的使用情況和可用空間
  - 以百分比形式顯示使用率

- **`p`**: 啟用個別 CPU 核心負載統計
  - 當系統有多個 CPU 核心時，分別顯示每個核心的負載
  - 顯示為 cpu0、cpu1、cpu2、cpu3 等欄位

- **`d10`**: 設定更新間隔為 10 秒
  - 預設是 2 秒更新一次
  - 較長的間隔適合長期監控，減少系統負擔

#### 輸出範例
```
Time         ARM    Core    H264 Core Temp (Max)  IRQ/s     RX B/s     TX B/s  %user  %nice   %sys  %idle  %iowt   %irq %s/irq %total   cpu0   cpu1   cpu2   cpu3 GPUMem Free Memory Free/Used
======== ======= ======= ======= =============== ====== ========== ========== ====== ====== ====== ====== ====== ====== ====== ====== ====== ====== ====== ====== =========== ================
10:58:29 1000Mhz  499Mhz    0Mhz 50.31C (50.31C)    718      2,482      6,492  12.63  10.10  17.68  55.55   0.00   0.00   0.00  44.45  29.30  39.40  59.60  39.40 242M ( 80%) 588,264 kB/14.8%
```

### 其他常用組合

#### `./bcmstat.sh cgd5` - 基本彩色監控
- **`c`**: 啟用彩色輸出
- **`g`**: GPU 記憶體監控
- **`d5`**: 每 5 秒更新

#### `./bcmstat.sh xgpyD10` - 進階系統監控
- **`x`**: 詳細 CPU 和記憶體統計
- **`g`**: GPU 記憶體監控
- **`p`**: 個別核心負載
- **`y`**: 顯示閾值事件標誌 (欠壓、頻率限制、熱節流)
- **`D`**: 顯示記憶體差值 (記憶體洩漏檢測)
- **`10`**: 每 10 秒更新

#### `./bcmstat.sh mrgf` - 無彩色簡單監控
- **`m`**: 單色輸出 (無彩色)
- **`r`**: 簡單 CPU 負載和記憶體統計
- **`g`**: GPU reloc 記憶體
- **`f`**: GPU malloc 記憶體

## 主要參數說明

### 顯示選項
- `c/m` - 啟用/停用彩色輸出
- `q/Q` - 抑制/顯示配置資訊
- `k` - 以人類友善單位顯示 RX/TX 和記憶體統計

### 監控選項
- `x/X` - 啟用/停用詳細的 CPU 負載和記憶體使用統計
- `r/R` - 啟用/停用簡單的 CPU 負載和記憶體使用統計
- `p/P` - 啟用/停用個別核心負載統計
- `g/G` - 啟用/停用 GPU reloc 記憶體統計
- `f/F` - 啟用/停用 GPU malloc 記憶體統計
- `y/Y` - 啟用/停用閾值事件標誌 (U=欠壓, F=ARM頻率限制, T=目前節流)
- `e/E` - 啟用/停用核心電壓顯示
- `t` - 顯示 PMIC 溫度 (如果可用)

### 進階選項
- `D` - 顯示記憶體差值 (負值：記憶體分配，正值：記憶體釋放)
- `A` - 顯示累積記憶體差值
- `T` - 停用 85°C 溫度限制
- `s/S` - 包含/排除 swap 記憶體統計

### 時間和優先權
- `d#` - 指定更新間隔 (秒)，預設為 2
- `H#` - 每 n 次迭代顯示標題 (0=無標題，預設 30)
- `J#` - 執行 n 次後退出 (0=不自動退出)
- `L/N/M` - 最低/正常/最高優先權執行

### 網路和自訂
- `i <interface>` - 監控指定的網路介面
- `o <columns>` - 自訂顯示欄位

### 版本和更新
- `V` - 檢查版本
- `U/W` - 更新到最新版本
- `h` - 顯示說明

## 設定檔

可以在 `~/.bcmstat.conf` 或 `~/.config/bcmstat.conf` 中設定預設選項：

```bash
# 建立預設配置
echo "xgpd10" > ~/.bcmstat.conf

# 現在直接執行就會使用這些預設值
./bcmstat.sh
```

## 權限說明

為了存取所有硬體功能 (特別是 GPU 相關資訊)，建議以 sudo 執行：

```bash
sudo python bcmstat.sh xgpd10
```

如果沒有 sudo 權限，某些功能可能無法使用，但工具會優雅降級並提供有用的錯誤訊息。

## 疑難排解

### 權限錯誤
如果遇到 "Permission denied" 錯誤：
```bash
sudo python bcmstat.sh
```

### GPU 資訊不可用
確保您的使用者在 video 群組中：
```bash
sudo usermod -a -G video $USER
```

### 網路介面未找到
指定正確的網路介面：
```bash
./bcmstat.sh i wlan0
```

## 輸出說明

工具會以表格形式顯示以下資訊：
- **Time**: 時間戳記
- **ARM/Core/H264/V3D/ISP**: 各處理器頻率
- **Core Temp**: 核心溫度 (最高溫度)
- **IRQ/s**: 每秒中斷次數
- **RX/TX B/s**: 網路接收/傳送位元組每秒
- **CPU 使用率**: user、nice、sys、idle、iowait、irq 百分比
- **核心負載**: 個別 CPU 核心使用率
- **GPU 記憶體**: GPU 記憶體使用情況
- **系統記憶體**: RAM 使用情況

彩色編碼：
- **白色**: 最小負載或使用率
- **綠色**: 正常使用率
- **黃色**: 中等使用率 
- **紅色**: 高使用率或資源不足

## 授權

本程式遵循 GNU General Public License v2.0 授權。

## 版本資訊

### 目前版本：0.6.0

### 最新更新內容 (2025年版本)

此版本由 pplovebobo 更新維護，包含以下重要改進：

#### 🆕 新增功能
- **擴展硬體支援**：完整支援樹莓派 5 和 Pi5+ 型號
- **增強記憶體支援**：支援最高 32GB RAM 配置
- **新增處理器支援**：
  - BCM2711 (樹莓派 4)
  - BCM2712 (樹莓派 5)
- **擴展型號識別**：
  - Pi Zero 2W
  - CM4S (計算模組 4S)
  - CM5 (計算模組 5)
  - Pi400
  - Pi4 Model A
- **新增製造商**：Stadium 製造商支援
- **進階 PCB 版本檢測**：支援更多硬體修訂版本

#### 🔧 功能改進
- **強化權限處理系統**：
  - 自動檢測使用者權限並提供清晰的錯誤訊息
  - 智慧型 sudo 提示，只在需要時要求提升權限
  - 檢查 video 群組成員資格以達最佳 GPU 存取
  - 優雅降級：某些功能需要更高權限時不會崩潰
- **改進的錯誤處理**：
  - 更友善的權限錯誤訊息
  - 詳細的疑難排解指導
  - 更好的檔案讀取錯誤處理
- **增強的 GPU 存取**：
  - 改進 vcgencmd 工具的檢測和使用
  - 更好的 GPU 記憶體統計準確性
  - 支援新的 GPU 功能

#### 🚀 效能優化
- **更準確的硬體檢測**：改進樹莓派型號和版本識別算法
- **最佳化記憶體使用**：更有效的系統資源監控
- **改進相容性**：更好的跨版本樹莓派 OS 支援

#### 🛠 修復問題
- **修復硬體識別問題**：
  - 解決新型樹莓派型號無法正確識別的問題
  - 修復記憶體大小檢測在大容量 RAM 上的錯誤
- **權限相關修復**：
  - 修復在非 root 使用者下的 GPU 存取問題
  - 改善 vcgencmd 工具的權限檢查
- **相容性修復**：
  - 修復在新版 Raspberry Pi OS 上的相容性問題
  - 解決 Python 3.x 環境下的編碼問題

#### 📝 文檔改進
- **新增中文文檔**：提供完整的繁體中文使用說明
- **詳細參數說明**：特別針對常用組合如 `xgpd10` 提供詳細解釋
- **使用範例豐富化**：增加更多實用的使用場景和範例
- **疑難排解指南**：提供常見問題的解決方案

#### 🎯 使用體驗改進
- **更清晰的輸出格式**：改進表格顯示和資訊組織
- **更好的彩色編碼**：增強視覺化效果，更容易識別系統狀態
- **更智慧的預設值**：針對不同樹莓派型號設定適當的預設參數

#### 🔐 安全性增強
- **安全的權限提升**：只在必要時要求 sudo 權限
- **更好的錯誤處理**：避免敏感資訊洩露
- **檔案存取保護**：安全地處理系統檔案讀取

這些改進使 bcmstat 成為監控現代樹莓派系統更可靠、更易用的工具，特別適合樹莓派 4 和 5 的使用者。

## 貢獻

歡迎貢獻和回報問題：https://github.com/pplovebobo/bcmstat

---

*此工具專為樹莓派優化，提供即時系統監控和效能分析功能。*
